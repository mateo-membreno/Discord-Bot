import discord
from discord.ext import commands
from youtube_dl import YoutubeDL
import os
from dotenv import load_dotenv

load_dotenv()
TOKEN = os.getenv("TOKEN")

intents = discord.Intents.default()
intents.members = True
intents.messages = True
client = commands.Bot(intents=intents, command_prefix='!') 
print("got client")

@client.command()
async def play(ctx, url):
    print("entered !play")
    try:
        channel = discord.utils.get(ctx.guild.voice_channels, name='General')
        await channel.connect()
    except Exception as e:
        await ctx.send(f"Error joining: {e}")
    YDL_OPTIONS = {'format': 'bestaudio', 'noplaylist':'True'}
    FFMPEG_OPTIONS = {'before_options': '-reconnect 1 -reconnect_streamed 1 -reconnect_delay_max 5', 'options': '-vn'}
    voice = ctx.voice_client

    if not voice.is_playing():
        with YoutubeDL(YDL_OPTIONS) as ydl:
            info = ydl.extract_info(url, download=False)
        URL = info['formats'][0]['url']
        voice.play(discord.FFmpegPCMAudio(URL, **FFMPEG_OPTIONS))
        voice.is_playing()
    else:
        await ctx.send("Bot is already playing audio")

@client.command()
async def jump(ctx, url):
  print("Play command invoked")
  try:
    channel = discord.utils.get(ctx.guild.voice_channels, name='General')
    await channel.connect()
  except Exception as e:
    print(f"Error in play command: {e}")

@client.command()
async def stop(ctx):
    voice = ctx.voice_client
    voice.stop()


client.run(TOKEN)